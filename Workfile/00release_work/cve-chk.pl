#!/usr/bin/perl

use strict;
use Spreadsheet::ParseExcel;
use v5.10;
use Cwd;

sub show($)
{
	my $ra = shift;
	foreach (@$ra) {
		say $_;
	}
}

sub list_commit()
{
	my $f = 'cve-list.xls';
	my $e = new Spreadsheet::ParseExcel;
	my $bk = $e->Parse($f);
	my $sh = $bk->{Worksheet}[0];
	my $maxrow = $sh->{MaxRow};
	my $col = 0;
	my $pwd = getcwd();
	
	for (my $i=1; $i<$maxrow; ++$i) {
		chdir $pwd;

		my $cve = $sh->{Cells}[$i][0]->Value;
		next unless (defined $cve);
		printf("\"%s\",", $cve);

		my $prj = $sh->{Cells}[$i][2]->Value;
		die "prj null?" unless (defined $prj);
		if (-e $prj) {
			chdir $prj;
			#say "chdir $prj";
		} else {
			say "path not found?";
		}		

		my $id = $sh->{Cells}[$i][3]->Value;
		die "id null?" unless (defined $id);
		#say $id;

		my $cmd;
		$cmd = sprintf("git --no-pager log --format='\"%%h\",\"%%an\",\"%%cn\",\"%%s\"' -1 %s", $id);
		#say $cmd;
		my $result = `$cmd`;
		printf("%s", $result);
	}
}

sub main()
{
	list_commit();
}

main;

