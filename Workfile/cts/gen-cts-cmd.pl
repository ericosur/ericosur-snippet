#!/usr/bin/perl

# gen cmd from txt

use strict;
use 5.010;
use Getopt::Std;

my %known = (
);

my $defile = 'failcase.txt';
my $prefix = './cts-tradefed ';	# default with prefix
my $nohead = qr(nohead);
my $local = qr(local);
my $opath = '../current-cts/tools/';

sub help()
{
	print<<EOL;

Usage: $0 [-n] [filename]

-e <arguments>  add extra arguments
-n              no prefix string [$prefix]
-h              help screen
-i <file name>  input file name
-o <file name>  output file name not path
-l              output to local
-p              output to STDOUT

Default input filename: $defile
Default output path: $opath

If script name contains [$nohead], no prefix would be used

EOL

}

sub main()
{
	my %myopt = ();
	getopts('e:nhi:o:lp', \%myopt);

	if ( $myopt{'h'} ) {
		help();
		return;
	}

	my $file;
	my $extra = "";
	my $ofile;


	# no prefix if option '-n', or script name with 'nohead'
	if ( $myopt{'n'} || ($0 =~ $nohead) ) {
		$prefix = '';
	}

	if ( $myopt{'i'} ) {
		$file = $myopt{'i'};
	} else {
		$file = $defile;
	}

	if ( $myopt{'l'} || ($0 =~ $local) ) {
		$opath = './';
	}

	if ( $myopt{'p'} ) {
		$ofile = "";
	} else {
		if ( $myopt{'o'} ) {
			$ofile = $opath . $myopt{'o'};
		} else {
			$ofile = $opath . $file . '.sh';
		}
	}

### start to output
	print "open $file...\noutput to $ofile...\n";
	open my $fh, $file or die "no such file?";

	my $ofh;
	open $ofh, "> $ofile" or $ofh = \*STDOUT;

	print $ofh "#!/bin/bash\n\n";
	printf $ofh "# generated by %s\n", $0;
	printf $ofh "# imported from %s\n", $file;
	if ( $myopt{'o'} ) {
		printf $ofh "# output to %s\n", $myopt{'o'};
	}
	if ( $myopt{'e'} ) {
		$extra = $myopt{'e'};
		printf $ofh "# with extra switch: %s\n", $extra;
	}
	print $ofh "\n";
	while (<$fh>) {
		if ( m/^#/ ) {
			print $ofh $_;
		} elsif ( m/^(\S+)\s+(\S+)/ ) {
			my ($cname, $mname) = ($1, $2);
			unless ( $known{$mname} )  {
				printf $ofh "%srun cts %s -c %s -m %s\n", $prefix, $extra, $cname, $mname;
			} else {
				#print STDERR "skip\n";
			}
		} else {
			printf $ofh "# %s", $_;
		}
	}
	close $fh;
	close $ofh;

	unless ( $ofh == \*STDOUT ) {
		my $cmd = sprintf("chmod +x %s", $ofile);
		system $cmd;
	}
}

main;

